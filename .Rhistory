date = NULL
)]
length_data[, date_parsed := lubridate::dmy(date)][, date := NULL]
# Merge
trip_data <- trip_data[base_outcomes, on = .(date_parsed, mode, tripid, catch_draw), nomatch = 0]
trip_data[, domain2 := NULL]
rm(sf_trip_data, scup_trip_data, bsb_trip_data,
size_data_sf, size_data_bsb,size_data_scup,
base_outcomes, catch_data)
data.table::setDT(trip_data)
# Precompute square roots once
trip_data[, `:=`(
sqrt_keep_sf_new = sqrt(tot_keep_sf_new),
sqrt_rel_sf_new = sqrt(tot_rel_sf_new),
sqrt_keep_bsb_new = sqrt(tot_keep_bsb_new),
sqrt_rel_bsb_new = sqrt(tot_rel_bsb_new),
sqrt_keep_sf_base = sqrt(tot_keep_sf_base),
sqrt_rel_sf_base = sqrt(tot_rel_sf_base),
sqrt_keep_bsb_base = sqrt(tot_keep_bsb_base),
sqrt_rel_bsb_base = sqrt(tot_rel_bsb_base),
sqrt_cat_scup_new = sqrt(tot_cat_scup_new),
sqrt_cat_scup_base = sqrt(tot_cat_scup_base)
)]
# Compute vA and v0
trip_data[, `:=`(
vA = beta_sqrt_sf_keep * sqrt_keep_sf_new +
#beta_NJ_sf_keep*NJ_dummy +
beta_sqrt_sf_release * sqrt_rel_sf_new +
beta_sqrt_bsb_keep * sqrt_keep_bsb_new +
beta_sqrt_bsb_release * sqrt_rel_bsb_new +
beta_sqrt_sf_bsb_keep * (sqrt_keep_sf_new * sqrt_keep_bsb_new) +
beta_sqrt_scup_catch * sqrt_cat_scup_new +
beta_cost * cost,
v0 = beta_sqrt_sf_keep * sqrt_keep_sf_base +
#beta_NJ_sf_keep*NJ_dummy +
beta_sqrt_sf_release * sqrt_rel_sf_base +
beta_sqrt_bsb_keep * sqrt_keep_bsb_base +
beta_sqrt_bsb_release * sqrt_rel_bsb_base +
beta_sqrt_sf_bsb_keep * (sqrt_keep_sf_base * sqrt_keep_bsb_base) +
beta_sqrt_scup_catch * sqrt_cat_scup_base +
beta_cost * cost
)]
# remove the temp sqrt columns to save memory
trip_data[, c("sqrt_keep_sf_new", "sqrt_rel_sf_new", "sqrt_keep_bsb_new", "sqrt_rel_bsb_new",
"sqrt_keep_sf_base", "sqrt_rel_sf_base", "sqrt_keep_bsb_base", "sqrt_rel_bsb_base",
"sqrt_cat_scup_new", "sqrt_cat_scup_base") := NULL]
mean_trip_data <- trip_data %>% data.table::data.table() %>%
.[, group_index := .GRP, by = .(date_parsed, mode, catch_draw, tripid)]
mean_trip_data <- mean_trip_data %>%
dplyr::mutate(n_alt = rep(2,nrow(.))) %>%
tidyr::uncount(n_alt) %>%
dplyr::mutate(alt = rep(1:2,nrow(.)/2),
opt_out = ifelse(alt == 2, 1, 0))
#Calculate the expected utility of alts 2 parameters of the utility function,
#put the two values in the same column, exponentiate, and calculate their sum (vA_col_sum)
data.table::setDT(mean_trip_data)
# Filter only alt == 2 once, and calculate vA and v0
mean_trip_data[alt == 2, c("vA", "v0") := .(
beta_opt_out * opt_out +
beta_opt_out_age * (age * opt_out) +
beta_opt_out_avidity * (total_trips_12 * opt_out)
)]
# Pre-compute exponential terms
mean_trip_data[, `:=`(exp_vA = exp(vA), exp_v0 = exp(v0))]
# Group by group_index and calculate probabilities and log-sums
mean_trip_data[, `:=`(
probA = exp_vA / sum(exp_vA),
prob0 = exp_v0 / sum(exp_v0),
log_sum_alt = log(sum(exp_vA)),
log_sum_base = log(sum(exp_v0))
), by = group_index]
# Calculate consumer surplus
mean_trip_data[, `:=`(
CS_base = log_sum_base / -beta_cost,
CS_alt = log_sum_alt / -beta_cost
)]
# Calculate change consumer surplus
mean_trip_data[, `:=`(
change_CS = CS_alt - CS_base
)]
mean_trip_data <- mean_trip_data %>%
dplyr::filter(alt==1) %>%
dplyr::select(-matches("beta")) %>%
dplyr::select(-"alt", -"opt_out", -"vA" , -"v0",-"exp_v0", -"exp_vA",
-"cost", -"age", -"total_trips_12", -"catch_draw", -"group_index",
-"log_sum_alt", -"log_sum_base", -"tot_keep_sf_base",  -"tot_rel_sf_base",  -"tot_cat_sf_base",
-"tot_keep_bsb_base",  -"tot_rel_bsb_base", -"tot_cat_bsb_base",
-"tot_keep_scup_base",-"tot_rel_scup_base",  -"tot_cat_scup_base", -"prob0")
all_vars<-c()
all_vars <- names(mean_trip_data)[!names(mean_trip_data) %in% c("date_parsed","mode", "tripid")]
mean_trip_data<-mean_trip_data  %>% data.table::as.data.table() %>%
.[,lapply(.SD, mean), by = c("date_parsed","mode", "tripid"), .SDcols = all_vars]
# multiply the average trip probability in the new scenario (probA) by each catch variable to get probability-weighted catch
list_names <- c("tot_keep_sf_new",   "tot_rel_sf_new",  "tot_cat_sf_new",
"tot_keep_bsb_new",  "tot_rel_bsb_new", "tot_cat_bsb_new",
"tot_keep_scup_new","tot_rel_scup_new",  "tot_cat_scup_new")
all_vars <- c(list_names)
mean_trip_data <- mean_trip_data %>%
data.table::as.data.table() %>%
.[,as.vector(all_vars) := lapply(.SD, function(x) x * probA), .SDcols = all_vars] %>%
.[]
## select the same number of choice occasions in the prediction year as in the calibration year
# We will multiply each simulated choice equation by an appropriate expansion factor,
# then multiply this expansion factor by the projection-year calendar adjustment to account for
# different numbers of weekend vs. weekday in the projection year versus the calibration
ndraws = 50
mean_trip_data<-mean_trip_data %>%
dplyr::left_join(n_choice_occasions, by = c("mode", "date_parsed")) %>%
dplyr::mutate(month = lubridate::month(date_parsed))  %>%
dplyr::mutate(dplyr::across(where(is.numeric), ~tidyr::replace_na(., 0))) %>%  #replace NAs for n_choice_occasions and estimated trips
dplyr::left_join(calendar_adjustments, by = c("mode", "month")) %>%
dplyr::rename(n_choice_occasions0=n_choice_occasions,
estimated_trips0=estimated_trips) %>%
dplyr::mutate(n_choice_occasions=n_choice_occasions0*expansion_factor,
expand=n_choice_occasions/ndraws)
mean_trip_data
list_names <- c("tot_keep_sf_new",   "tot_rel_sf_new",  "tot_cat_sf_new",
"tot_keep_bsb_new",  "tot_rel_bsb_new", "tot_cat_bsb_new",
"tot_keep_scup_new","tot_rel_scup_new",  "tot_cat_scup_new",
"probA", "change_CS")
all_vars <- c(list_names)
mean_trip_data <- mean_trip_data %>%
data.table::as.data.table() %>%
.[,as.vector(all_vars) := lapply(.SD, function(x) x * expand), .SDcols = all_vars] %>%
.[]
expansion_factors<-mean_trip_data %>%
dplyr::select("date_parsed","mode", "tripid", "expand")
#process length data
pattern_vars <- grep("^keep_(sf_|bsb_|scup_)[0-9.]*$|^release_(sf_|bsb_|scup_)[0-9.]*$",
names(length_data), value = TRUE)
length_data<-length_data  %>% data.table::as.data.table() %>%
.[,lapply(.SD, mean), by = c("date_parsed","mode", "tripid"), .SDcols = pattern_vars]
length_data<-length_data %>%
dplyr::right_join(expansion_factors, b=c("date_parsed","mode", "tripid"))
length_data <- length_data %>%
data.table::as.data.table() %>%
.[,as.vector(pattern_vars) := lapply(.SD, function(x) x * expand), .SDcols = pattern_vars] %>%
.[]
mean_trip_data <- mean_trip_data %>%
dplyr::rename(n_trips_alt = probA)
# Ensure mean_trip_data is a data.table
data.table::setDT(mean_trip_data)
list_names <- c("change_CS","n_trips_alt")
aggregate_trip_data_mode <- mean_trip_data[, lapply(.SD, sum), by = .(mode), .SDcols = list_names]
# Aggregate for all modes
aggregate_trip_data_allmodes <- mean_trip_data[, lapply(.SD, sum), .SDcols = list_names][
, mode := "all modes"
]
# Combine and reshape
model_output1 <- rbindlist(list(aggregate_trip_data_mode, aggregate_trip_data_allmodes), use.names=TRUE)
model_output1_long <- melt(
model_output1,
id.vars = c("mode"),   # keep these as identifiers
measure.vars = c("change_CS", "n_trips_alt"),
variable.name = "metric",
value.name = "value"
)
model_output1_long[, metric := fifelse(metric == "change_CS", "CV",
fifelse(metric == "n_trips_alt", "predicted trips", "metric"))]
model_output1_long$species<-"NA"
pattern_vars <- grep(
"^keep_(sf_|bsb_|scup_)[0-9.]*$|^release_(sf_|bsb_|scup_)[0-9.]*$",
names(length_data),
value = TRUE
)
## Select needed columns and add month
length_data1 <- length_data[, .SD, .SDcols = c("date_parsed", "mode", pattern_vars)]
length_data1[, month := lubridate::month(date_parsed)]
## Aggregate sums by mode + month
length_data1 <- length_data1[, lapply(.SD, sum),
by = .(mode, month),
.SDcols = pattern_vars]
## MELT to long
length_data1 <- melt(
length_data1,
id.vars = c("month", "mode"),
variable.name = "Var",
value.name = "number_at_length"
)
## Split Var into keep_release, species, length
length_data1[, c("keep_release", "species", "length") := tstrsplit(Var, "_", fixed = TRUE)]
length_data1[, length := as.numeric(length)]
## Join with l_w_conversion
setDT(l_w_conversion)
length_data1 <- l_w_conversion[length_data1, on = .(month, species)]
## Compute weight
length_data1[, weight := fcase(
species == "scup", exp(ln_a + b * log(length)),
species %chin% c("sf", "bsb"), a * length^b,
default = NA_real_
)]
length_data1[, weight := weight * 2.20462262185]
## Totals
length_data1[, keep_weight := fifelse(keep_release == "keep",
number_at_length * weight,
0)]
length_data1[, release_weight := fifelse(keep_release == "release",
number_at_length * weight,
0)]
length_data1[, keep_numbers := fifelse(keep_release == "keep",
number_at_length,
0)]
length_data1[, release_numbers := fifelse(keep_release == "release",
number_at_length,
0)]
## Discard mortality weight
length_data1[, discmort_weight := fcase(
keep_release == "release" & species == "sf", 0.10 * number_at_length * weight,
keep_release == "release" & species == "scup", 0.15 * number_at_length * weight,
keep_release == "release" & species == "bsb", 0.15 * number_at_length * weight,
default = 0
)]
## Discard mortality numbers
length_data1[, discmort_number := fcase(
keep_release == "release" & species == "sf", 0.10 * number_at_length,
keep_release == "release" & species == "scup", 0.15 * number_at_length,
keep_release == "release" & species == "bsb", 0.15 * number_at_length,
default = 0
)]
## Summarise by species, mode
length_data1 <- length_data1[, .(
keep_numbers = sum(keep_numbers),
release_numbers = sum(release_numbers),
keep_weight = sum(keep_weight),
release_weight = sum(release_weight),
discmort_weight = sum(discmort_weight),
discmort_number = sum(discmort_number)
), by = .(species, mode)]
length_data_long <- melt(
length_data1,
id.vars = c("species", "mode"),   # keep these as identifiers
measure.vars = c("keep_numbers", "release_numbers",
"keep_weight", "release_weight",
"discmort_weight", "discmort_number"),
variable.name = "metric",
value.name = "value"
)
## Remove NAs
length_data_long <- length_data_long[!is.na(value)]
## Split and classify
length_data_long_all <- length_data_long[, .(value = sum(value)),
by = .(metric, species)]
length_data_long_all[, mode := "all modes"]
## Final bind
length_output <- rbindlist(list(length_data_long_all, length_data_long) ,
use.names = TRUE,
fill = TRUE
)
predictions <- rbindlist(
list(length_output, model_output1_long),
use.names = TRUE,
fill = TRUE) %>%
dplyr::mutate(state = st, draw=dr)
predictions<-predictions %>%
dplyr::mutate(state=st, draw=dr)
predictions
test<- predict_rec_catch(st = "RI", dr = x,
directed_trips = directed_trips2, catch_data,
sf_size_data = sf_size_data2,
bsb_size_data = bsb_size_data2,
scup_size_data = scup_size_data2,
l_w_conversion, calib_comparison, n_choice_occasions,
calendar_adjustments, base_outcomes)
## Rhode Island
if(any(grepl("ri", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ri", saved_regs$input))
source(here::here("recDST/model_run_RI.R"))
}
md
calib_row <- calib_lookup[mode == md]
setDT(calib_lookup)
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
calendar_adjustments <- readr::read_csv(
file.path(here::here(paste0("Data/proj_year_calendar_adjustments_MA.csv"))), show_col_types = FALSE)
calendar_adjustments <- readr::read_csv(
file.path(here::here(paste0("Data/proj_year_calendar_adjustments_new_MA.csv"))), show_col_types = FALSE)
calendar_adjustments
calendar_adjustments <- readr::read_csv(
file.path(here::here(paste0("Data/proj_year_calendar_adjustments_new_MA.csv"))), show_col_types = FALSE) %>%
dplyr::filter(draw == x)
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
## Rhode Island
if(any(grepl("ri", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ri", saved_regs$input))
source(here::here("recDST/model_run_RI.R"))
}
## Connecticut
if(any(grepl("ct", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ct", saved_regs$input))
source(here::here("recDST/model_run_CT.R"))
}
## Connecticut
if(any(grepl("ct", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ct", saved_regs$input))
source(here::here("recDST/model_run_CT.R"))
}
## New York
if(any(grepl("ny", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ny", saved_regs$input))
source(here::here("recDST/model_run_NY.R"))
}
## New Jersey
if(any(grepl("nj", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("nj", saved_regs$input))
source(here::here("recDST/model_run_NJ.R"))
}
## Maryland
if(any(grepl("md", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("md", saved_regs$input))
source(here::here("recDST/model_run_MD.R"))
}
## Deleware
if(any(grepl("de", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("de", saved_regs$input))
source(here::here("recDST/model_run_DE.R"))
}
## Virginia
if(any(grepl("va", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("va", saved_regs$input))
source(here::here("recDST/model_run_VA.R"))
}
## North Carolina
if(any(grepl("nc", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("nc", saved_regs$input))
source(here::here("recDST/model_run_NC.R"))
}
#### Read in size data ####
size_data <- readr::read_csv(file.path(here::here("Data"), "projected_catch_at_length_new.csv"), show_col_types = FALSE)  %>%
dplyr::filter(state == "VA")
l_w_conversion <- readr::read_csv(file.path(data_path, "L_W_Conversion.csv"), show_col_types = FALSE)  %>%
dplyr::filter(state=="VA")
## Virginia
if(any(grepl("va", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("va", saved_regs$input))
source(here::here("recDST/model_run_VA.R"))
}
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
mode
calib_lookup
directed_trips
sf_size_data
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
md
class(md)
calib_lookup[mode == md]
directed_trips[mode == md]
class(directed_trips$mode)
md
directed_trips[mode == md]
unique(directed_trips$mode)
directed_trips2
mode_draw
md
library(magrittr)
library(data.table)
args = "SQ"
saved_regs<- read.csv(here::here(paste0("saved_regs/regs_", args[1], ".csv")))
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
unique(directed_trips$mode)
md
#  sublegal_harvest_floor
directed_trips_md <- data.table::as.data.table(directed_trips[mode == md])
calib_lookup
calib_lookup
setDT(directed_trips)
setDT(catch_data)
setDT(calib_comparison)
setDT(sf_size_data)
setDT(bsb_size_data)
setDT(scup_size_data)
mode_draw <- c("sh", "pr", "fh")
calib_lookup <- calib_comparison %>%
dplyr::select(mode, species, rel_to_keep, keep_to_rel,
p_rel_to_keep, p_keep_to_rel,
prop_sub_kept, prop_legal_rel) %>%
tidyr::pivot_wider(
names_from = species,
values_from = c(rel_to_keep, keep_to_rel, p_rel_to_keep, p_keep_to_rel, prop_sub_kept, prop_legal_rel),
names_glue = "{.value}_{species}"
)
calib_lookup
setDT(calib_lookup)
setkey(calib_lookup, mode)
setDT(directed_trips)
setDT(catch_data)
setDT(calib_comparison)
setDT(sf_size_data)
setDT(bsb_size_data)
setDT(scup_size_data)
directed_trips
directed_trips_md <- directed_trips %>% dplyr::filter(mode == md)
floor_subl_sf_harv <- min(directed_trips_md$fluke_min_y2) - 3 * 2.54
# Filter length data by mode
sf_size_data1 <- sf_size_data[mode == md]
catch_data_md <- catch_data[mode == md]
sf_catch_check_md <- sum(catch_data_md$sf_cat)
calib_row <- calib_lookup[mode == md]
View(calib_row)
directed_trips
class(directed_trips)
class(sf_size_data)
class(catch_data)
class(calib_lookup)
library(magrittr)
library(data.table)
args = "SQ"
saved_regs<- read.csv(here::here(paste0("saved_regs/regs_", args[1], ".csv")))
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
saved_regs<- read.csv(here::here(paste0("saved_regs/regs_", args[1], ".csv")))
library(magrittr)
library(data.table)
args = "SQ"
saved_regs<- read.csv(here::here(paste0("saved_regs/regs_", args[1], ".csv")))
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
library(magrittr)
library(data.table)
args = "SQ"
saved_regs<- read.csv(here::here(paste0("saved_regs/regs_", args[1], ".csv")))
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
## Massachusetts
if(any(grepl("ma", saved_regs$input))){
save_regs <- saved_regs %>%
dplyr::filter(grepl("ma", saved_regs$input))
source(here::here("recDST/model_run_MA.R"))
}
